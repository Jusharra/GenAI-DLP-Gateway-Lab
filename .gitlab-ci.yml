stages:
  - validate
  - test
  - opa
  - checkov
  - terraform
  - evidence

# Default image + tooling for Python, OPA, Checkov
default:
  image: python:3.11
  before_script:
    - pip install -r platform/devsecops/python/requirements-dev.txt
    - pip install checkov
    # Install OPA CLI
    - curl -L -o /usr/local/bin/opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64_static
    - chmod +x /usr/local/bin/opa

# ---------- STAGE: validate / unit tests ----------

python-tests:
  stage: validate
  script:
    - pytest platform/devsecops/python
  artifacts:
    when: always
    paths:
      - .pytest_cache/
    expire_in: 1 week

# ---------- STAGE: policy (OPA & Checkov) ----------

opa-tests:
  stage: policy
  script:
    # Runtime DLP policy tests
    - opa test platform/governance/policies_as_code/opa/dlp_runtime -v
    # Data-movement policy tests
    - opa test platform/mlsecops/data_movement -v

checkov_scan:
  stage: checkov
  image: bridgecrew/checkov:latest
  script:
    # Ensure we're at repo root (GitLab does this by default)
    - ls
    - checkov -d platform/iac --config-file checkov.yml
  artifacts:
    when: always
    paths:
      - platform/evidence/checkov.json
    expire_in: 7 days
  only:
    - main
    - merge_requests

# ---------- STAGE: plan (Terraform) ----------

terraform-plan:
  stage: plan
  image: hashicorp/terraform:1.9.8
  variables:
    TF_IN_AUTOMATION: "true"
  before_script:
    - terraform -version
  script:
    - cd platform/iac
    - terraform init -input=false
    - terraform validate
    - terraform plan -input=false -out=tfplan
    # Export machine-readable plan for evidence merge
    - terraform show -json tfplan > ../evidence/terraform_plan.json
  artifacts:
    paths:
      - platform/iac/tfplan
      - platform/evidence/terraform_plan.json
    expire_in: 1 week

# ---------- STAGE: evidence (audit bundle) ----------

evidence-bundle:
  stage: evidence
  script:
    # Merge whatever evidence exists into one auditor JSON
    - python platform/devsecops/python/scripts/generate_evidence_report.py
  artifacts:
    paths:
      - platform/evidence/evidence_unified.json
    expire_in: 4 weeks
  needs:
    - job: checkov-scan
    - job: terraform-plan
