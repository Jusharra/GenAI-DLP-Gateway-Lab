include:
  - local: "platform/devsecops/gitlab/base-ci.yml"

stages:
  - build
  - validate
  - test
  - security
  - policy-check
  - deploy
  - evidence

build_lambda_packages:
  stage: build
  image: python:3.13
  before_script:
    - apt-get update
    - apt-get install -y zip
  script:
    - mkdir -p $PY_ROOT/package
    - pip install -r $PY_ROOT/requirements-dev.txt -t $PY_ROOT/package/
    - cp $PY_ROOT/dlp_handler.py $PY_ROOT/rag_handler.py $PY_ROOT/package/
    - cd $PY_ROOT/package
    - mkdir -p ../dist
    - zip -r ../dist/dlp_package.zip dlp_handler.py
    - zip -r ../dist/rag_package.zip rag_handler.py
  artifacts:
    paths:
      - $PY_ROOT/dist/
  only:
    - main
    - master
    - develop
    - merge_requests


validate_terraform:
  extends: .validate_tf_template
  only: [main, master, develop, merge_requests]

test_python:
  extends: .test_python_template
  only: [main, master, develop, merge_requests]

security_scan:
  stage: security
  image: Python 3.13.5
  script:
    - echo "security_scan placeholder"
  allow_failure: true
  only: [main, master, develop, merge_requests]


policy_check:
  extends: .policy_check_template
  only: [main, master, develop, merge_requests]

deploy:
  extends: .deploy_tf_template
  only: [main, master]

generate_evidence:
  extends: .evidence_template
  only: [main, master]
