stages:
  - build
  - validate
  - test
  - security
  - policy-check
  - deploy
  - evidence

# Root for Terraform
variables:
  TF_ROOT: "platform/devsecops/terraform/evidence_s3"
  PY_ROOT: "platform/devsecops/python"

# Youâ€™ll set AWS creds + EVIDENCE_BUCKET_NAME as CI/CD variables in GitLab.
# Example:
#   AWS_ACCESS_KEY_ID
#   AWS_SECRET_ACCESS_KEY
#   AWS_DEFAULT_REGION
#   EVIDENCE_BUCKET_NAME

# -----------------------------
# 1) Build Lambda packages
# -----------------------------
build_lambda_packages:
  stage: build
  image: python:3.11
  script:
    - pip install -r $PY_ROOT/requirements-dev.txt -t $PY_ROOT/package/
    - cp $PY_ROOT/dlp_handler.py $PY_ROOT/rag_handler.py $PY_ROOT/package/
    - cd $PY_ROOT/package
    - mkdir -p ../dist
    - zip -r ../dist/dlp_package.zip dlp_handler.py
    - zip -r ../dist/rag_package.zip rag_handler.py
  artifacts:
    paths:
      - $PY_ROOT/dist/
  only:
    - main
    - master
    - develop
    - merge_requests

# -----------------------------
# 2) Validate Terraform & code
# -----------------------------
validate_terraform:
  stage: validate
  image: hashicorp/terraform:1.6.6
  needs:
    - build_lambda_packages
  script:
    - cd $TF_ROOT
    - terraform init -backend=false
    - terraform validate
  only:
    - main
    - master
    - develop
    - merge_requests

test_python:
  stage: test
  image: python:3.11
  needs:
    - build_lambda_packages
  script:
    - pip install -r $PY_ROOT/requirements-dev.txt
    - pytest || echo "pytest not yet configured, skipping tests for now"
  only:
    - main
    - master
    - develop
    - merge_requests

# -----------------------------
# 3) Security scanning (placeholder)
# -----------------------------
security_scan:
  stage: security
  image: python:3.11
  script:
    - echo "Run SAST / secrets scanning here (e.g., bandit, trufflehog)."
  allow_failure: true
  only:
    - main
    - master
    - develop
    - merge_requests

# -----------------------------
# 4) Policy-as-Code check with OPA
# -----------------------------
policy_check:
  stage: policy-check
  image: alpine:3.19
  needs:
    - build_lambda_packages
  before_script:
    # Install terraform + opa (lightweight lab approach)
    - apk add --no-cache curl bash jq
    - curl -Lo /usr/local/bin/terraform https://releases.hashicorp.com/terraform/1.6.6/terraform_1.6.6_linux_amd64.zip
    - apk add --no-cache unzip
    - unzip /usr/local/bin/terraform -d /usr/local/bin/ || true
    - chmod +x /usr/local/bin/terraform || true
    - curl -Lo /usr/local/bin/opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
    - chmod +x /usr/local/bin/opa
  script:
    - cd $TF_ROOT
    - terraform init -backend=false
    - terraform plan -out=tfplan
    - terraform show -json tfplan > tfplan.json
    - opa eval --format pretty --fail-defined \
        -i tfplan.json \
        -d platform/governance/policies_as_code/opa/terraform_guardrails.rego \
        "data.terraform.guardrails.dlp.deny"
  only:
    - main
    - master
    - develop
    - merge_requests

# -----------------------------
# 5) Deploy (manual, controlled)
# -----------------------------
deploy:
  stage: deploy
  image: hashicorp/terraform:1.6.6
  needs:
    - build_lambda_packages
    - validate_terraform
    - policy_check
  script:
    - cd $TF_ROOT
    - terraform init
    - terraform apply -auto-approve
  environment:
    name: dlp-gateway-lab
  when: manual
  only:
    - main
    - master

# -----------------------------
# 6) Evidence report generation
# -----------------------------
generate_evidence:
  stage: evidence
  image: python:3.11
  needs:
    - deploy
  script:
    - pip install boto3
    - python platform/devsecops/scripts/generate_evidence_report.py
  artifacts:
    paths:
      - evidence/
  when: manual
  only:
    - main
    - master

